from pyspark.sql import SparkSession
from pyspark.sql.functions import udf, col
from geopy.distance import geodesic
import geohash2

# Initialize Spark session
spark = SparkSession.builder.appName("GeohashBetweenPoints").getOrCreate()

# Function to calculate geohash
def generate_geohash(lat, lon, precision=6):
    return geohash2.encode(lat, lon, precision)

# UDF for generating geohash
generate_geohash_udf = udf(lambda lat, lon: generate_geohash(lat, lon))

# Create a DataFrame with the lost and found coordinates
data = [
    {"LostLat": 12.971598, "LostLon": 77.594566, "FoundLat": 12.29581, "FoundLon": 76.639381}
]
df = spark.createDataFrame(data)

# Add geohashes for lost and found points
df = df.withColumn("LostGeohash", generate_geohash_udf(col("LostLat"), col("LostLon"))) \
       .withColumn("FoundGeohash", generate_geohash_udf(col("FoundLat"), col("FoundLon")))

# Define function to find intermediate geohashes
def get_geohashes_between(lat1, lon1, lat2, lon2, precision=6):
    # Initialize start and end geohash
    start_geohash = generate_geohash(lat1, lon1, precision)
    end_geohash = generate_geohash(lat2, lon2, precision)
    
    # Helper to calculate distance
    def haversine_dist(coord1, coord2):
        return geodesic(coord1, coord2).meters

    # Generate geohashes in steps
    current_lat, current_lon = lat1, lon1
    target_lat, target_lon = lat2, lon2
    geohash_list = [start_geohash]
    while haversine_dist((current_lat, current_lon), (target_lat, target_lon)) > 0.01:
        # Compute next step direction
        step_lat = (target_lat - current_lat) * 0.01
        step_lon = (target_lon - current_lon) * 0.01
        current_lat += step_lat
        current_lon += step_lon
        current_geohash = generate_geohash(current_lat, current_lon, precision)
        if current_geohash != geohash_list[-1]:
            geohash_list.append(current_geohash)
    if end_geohash not in geohash_list:
        geohash_list.append(end_geohash)
    return geohash_list

# UDF to get geohashes between two points
get_geohashes_between_udf = udf(lambda lat1, lon1, lat2, lon2: get_geohashes_between(lat1, lon1, lat2, lon2))

# Add column with all intermediate geohashes
df = df.withColumn("IntermediateGeohashes", get_geohashes_between_udf(
    col("LostLat"), col("LostLon"), col("FoundLat"), col("FoundLon")
))

# Show the result
df.show(truncate=False)
